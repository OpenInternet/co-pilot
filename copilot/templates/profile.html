{% extends "base.html" %}
{% from "rule_item.html" import render_rules %}
{% from "alert.html" import render_alerts %}
{% from "submit.html" import render_submit_buttons %}


{% block body %}
{{ render_alerts(get_flashed_messages(with_categories=true))}}
<form name="profile_form" action="{{ url_for('profile_save') }}" method="post">
    {{ form.csrf_token }}

    <section class="section--center mdl-grid">
        <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet= mdl-cell---hide-phone">
        </div>
        <div class="mdl-card profile-list mdl-cell mdl-cell--8-col mdl-shadow--4dp">
            <div class="mdl-card__title">
                <h2 class="mdl-card__title-text">CoPilot Profile</h2>
            </div>
            <div class="mdl-card__supporting-text">
                Customize your CoPilot profile below.
            </div>
            <div class="mdl-card__actions mdl-card--border">
                <div class="plugin-list-action mdl-list">
                        <div class="mdl-textfield mdl-js-textfield">
                            {{ render_field(form.prof_name, class='mdl-textfield__input') }}
                            <span class="mdl-textfield__error">You need to give a name to each profile.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Rules Section -->

    <div id="rule_list">
        {% for item in form.rules %}
        <section class="section--center mdl-grid">
            <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet= mdl-cell---hide-phone">
            </div>
            <div class="mdl-card profile-list mdl-cell mdl-cell--8-col mdl-shadow--4dp">
                <div class="mdl-card__title">
                    <h2 class="mdl-card__title-text">CoPilot Rule</h2>
                </div>
                <div class="mdl-card__actions mdl-card--border">
                    {% for subfield in field %}
                        {% if subfield.short_name != "csrf_token" %}
                            {# Deal with Errors First #}
                            {% if subfield.errors %}
                                {% for error in subfield.errors %}
                                    <p class="error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                            {# Actual data goes here. #}
                            {{ subfield(class_="u-full-width "+subfield.short_name,
                               onclick="update_from_{0}(this)".format(subfield.short_name)) }}
                            <div class="help">
                                {{ subfield.description }}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            </div>
    <!-- New rule button -->
    <div class="add_new_rule">
        <button class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored" id="new_rule_button">
            <i class="material-icons">add</i>
        </button>
        <span for="new_rule_button" class="mdl-tooltip">Click to add a <br> new rule to your profile.</span>
    </div>







<meta id="all_actions" name="all_actions" content="{% for action in action_pairs %}{{ action }} {% endfor %}">
<meta id="all_targets" name="all_targets" content="{% for tar in all_targets %}{{ tar }} {% endfor %}">
{% for action in action_pairs %}
    <meta id="pairs-{{ action }}" name="pairs-{{ action }}" content="{% for tar in action_pairs[action] %}{{ tar }} {% endfor %}">
{% endfor %}
<script type="text/javascript" src="{{ url_for('static', filename='js/profile.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/visual.js') }}"></script>
<form name="profile_form" action="{{ url_for('profile_save') }}" method="post">
    {{ form.csrf_token }}
    <div id="rule_list">
        {% if form.prof_name %}
        <div class="row rule_name">
        <label for="Name">Name</label>
        {{form.prof_name }}
        {% endif %}
        </div>
        <div class="row mock_rule">
            <div class="one columns">
                <p></p>
            </div>
            <div class="three columns">
                <div class="rule_desc_label">Action</div>
                <p>The action to be taken against the "targeted" traffic. e.g. block, throttle, redirect, or monitor.</p>
            </div>
            <div class="three columns">
                <div class="rule_desc_label">Target</div>
                <p>The type of network traffic to be targeted by this rule. e.g. HTTP, HTTPS, DNS, or URL.</p>
            </div>
            <div class="three columns">
                <div class="rule_desc_label">Sub-Target</div>
                <p>A URL or ip-address that should be specifically targeted. (Use <strong>*</strong> to target ALL traffic.</p>
            </div>
        </div>
        {% for item in form.rules %}
        {{ render_rules(item) }}
        {% endfor %}
        <div class="row mock_rule" id="addButton">
            <div class="one columns">
                <img src="{{ url_for('static', filename='images/add_rule.png') }}" onclick="addRule()">
            </div>
        </div>
    </div>
{% endblock %}


{% block submit %}
    <a href='#' onclick='overlay()' class="button button-primary blues">Save & Apply</a>
    <div id="overlay">
        <div class="paper">
            <div class="submit">
                Where would you like to save your profile?
                {% for location in locations %}
                <div class="row input_field">
                    <input type="submit" name="submit_action" value="{{ location }}" class="button-primary blues">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</form>
{% endblock %}
