{% extends "base.html" %}
{% from "rule_item.html" import render_rules %}
{% from "alert.html" import render_alerts %}
{% from "submit.html" import render_submit_buttons %}
{% from "_formhelpers.html" import render_field %}


{% block body %}
{{ render_alerts(get_flashed_messages(with_categories=true))}}
<meta id="all_actions" name="all_actions" content="{% for action in action_pairs %}{{ action }} {% endfor %}">
<meta id="all_targets" name="all_targets" content="{% for tar in all_targets %}{{ tar }} {% endfor %}">
<script type="text/javascript" src="{{ url_for('static', filename='js/profile.js') }}"></script>

<form name="profile_form" action="{{ url_for('profile_save') }}" method="post">
    {{ form.csrf_token }}
    <section class="section--center mdl-grid">
        <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet= mdl-cell---hide-phone">
        </div>
        <div class="mdl-card profile-list mdl-cell mdl-cell--8-col mdl-shadow--4dp">
            <div class="mdl-card__title">
                <h2 class="mdl-card__title-text">CoPilot Profile</h2>
            </div>
            <div class="mdl-card__supporting-text">
                Give your CoPilot profile a name.
            </div>
            <div class="mdl-card__actions mdl-card--border">
                <div class="mdl-textfield mdl-js-textfield">
                    {{ render_field(form.prof_name, class='mdl-textfield__input') }}
                    <span class="mdl-textfield__error">You need to give a name to each profile.</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Rules Section -->

    <div id="rule_list">
        {% for item in form.rules %}
        <section class="section--center mdl-grid">
            <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet= mdl-cell---hide-phone">
            </div>
            <div class="mdl-card profile-list mdl-cell mdl-cell--8-col mdl-shadow--4dp">
                <div class="mdl-card__title">
                    <h2 class="mdl-card__title-text">Rule</h2>
                </div>
                <div class="mdl-card__actions mdl-card--border">
                    {{ render_rules(item) }}
                </div>
            </div>
        </section>
        {% endfor %}

        <!-- New rule button -->
        <div class="add_new_rule">
            <button class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored" id="addButton" onclick="addRule(); return false;">
                <i class="material-icons">add</i>
            </button>
            <span for="new_rule_button" class="mdl-tooltip">Click to add a <br> new rule to your profile.</span>
        </div>

        <div class="add_new_rule">
            <button id="show-dialog" type="button" class="mdl-button mdl-js-button mdl-button--raised">Save & Apply</button>
        </div>

    </div>
</form>

        <!-- Dialogue -->
        <dialog class="mdl-dialog">
            <h4 class="mdl-dialog__title">Where would you like to save your profile?</h4>
            <div class="mdl-dialog__content">
                    {% for location in locations %}
                <button class="mdl-button mdl-js-button mdl-button--raised" type="submit" form="profile_form" value="{{ location }}">{{ location }}</button>
                    {% endfor %}
            </div>
        </dialog>
        <script>
         var dialog = document.querySelector('dialog');
         var showDialogButton = document.querySelector('#show-dialog');
         if (! dialog.showModal) {
             dialogPolyfill.registerDialog(dialog);
         }
         showDialogButton.addEventListener('click', function() {
             dialog.showModal();
         });
        </script>

{% endblock %}






{% for action in action_pairs %}
    <meta id="pairs-{{ action }}" name="pairs-{{ action }}" content="{% for tar in action_pairs[action] %}{{ tar }} {% endfor %}">
{% endfor %}
<script type="text/javascript" src="{{ url_for('static', filename='js/profile.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/visual.js') }}"></script>
<form name="profile_form" action="{{ url_for('profile_save') }}" method="post">
    {{ form.csrf_token }}
    <div id="rule_list">
        {% if form.prof_name %}
        <div class="row rule_name">
        <label for="Name">Name</label>
        {{form.prof_name }}
        {% endif %}
        </div>
        <div class="row mock_rule">
            <div class="one columns">
                <p></p>
            </div>
            <div class="three columns">
                <div class="rule_desc_label">Action</div>
                <p>The action to be taken against the "targeted" traffic. e.g. block, throttle, redirect, or monitor.</p>
            </div>
            <div class="three columns">
                <div class="rule_desc_label">Target</div>
                <p>The type of network traffic to be targeted by this rule. e.g. HTTP, HTTPS, DNS, or URL.</p>
            </div>
            <div class="three columns">
                <div class="rule_desc_label">Sub-Target</div>
                <p>A URL or ip-address that should be specifically targeted. (Use <strong>*</strong> to target ALL traffic.</p>
            </div>
        </div>
        {% for item in form.rules %}
        {{ render_rules(item) }}
        {% endfor %}
        <div class="row mock_rule" id="addButton">
            <div class="one columns">
                <img src="{{ url_for('static', filename='images/add_rule.png') }}" onclick="addRule()">
            </div>
        </div>
    </div>


{% block submit %}
    <a href='#' onclick='overlay()' class="button button-primary blues">Save & Apply</a>
    <div id="overlay">
        <div class="paper">
            <div class="submit">
                Where would you like to save your profile?
                {% for location in locations %}
                <div class="row input_field">
                    <input type="submit" name="submit_action" value="{{ location }}" class="button-primary blues">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</form>
{% endblock %}
